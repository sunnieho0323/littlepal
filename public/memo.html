<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mailbox - Virtual Pet</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    .memo-row { display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; }
    .badges { display:flex; gap:8px; }
  </style>
</head>
<body class="container">
  <h5>
    Mailbox
    <span id="unreadBadge" class="new badge" data-badge-caption="unread">0</span>
  </h5>

  <div class="row">
    <div class="input-field col s6">
      <input id="search" type="text" placeholder="Search subject or body"/>
    </div>
    <div class="input-field col s3">
      <select id="sort">
        <option value="createdAt:desc" selected>Newest</option>
        <option value="createdAt:asc">Oldest</option>
        <option value="subject:asc">Subject A→Z</option>
        <option value="subject:desc">Subject Z→A</option>
      </select>
      <label>Sort</label>
    </div>
    <div class="input-field col s3">
      <input id="label" type="text" placeholder="Label (optional)"/>
    </div>
  </div>

  <div class="row">
    <label>
      <input type="checkbox" id="unreadOnly"/>
      <span>Unread only</span>
    </label>
    <label style="margin-left:16px;">
      <input type="checkbox" id="includeExpired"/>
      <span>Include expired</span>
    </label>
  </div>

  <div id="list"></div>

  <ul class="pagination center">
    <li id="prevLi" class="waves-effect"><a href="#!" id="prev">Prev</a></li>
    <li class="active"><a href="#!" id="pageNum">1</a></li>
    <li id="nextLi" class="waves-effect"><a href="#!" id="next">Next</a></li>
  </ul>


  <a class="btn modal-trigger" href="#createModal">New Memo</a>

  <!-- Create/Edit Modal -->
  <div id="createModal" class="modal">
    <div class="modal-content">
      <h5 id="modalTitle">New Memo</h5>
      <div class="input-field"><input id="to" placeholder="Recipient UserId"/></div>
      <div class="input-field"><input id="subject" placeholder="Subject"/></div>
      <div class="input-field"><textarea id="body" class="materialize-textarea" placeholder="Body"></textarea></div>
      <div class="input-field"><input id="labels" placeholder="Labels (comma separated)"/></div>
      <div class="input-field"><input id="expiresAt" type="datetime-local"/></div>
      <p>Attachment (one-time claim): <input id="attachmentJson" placeholder='{"type":"currency","payload":{"gold":100}}'/></p>
    </div>
    <div class="modal-footer">
      <a href="#!" id="btnSubmit" class="modal-close waves-effect waves-green btn">Submit</a>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  const API = (p)=> `/api${p}`;

  // Add headers: JWT if present; else dev mock x-user-id
  function getHeaders() {
    const h = { 'Content-Type':'application/json' };
    const token = localStorage.getItem('jwt');
    if (token) h['Authorization'] = `Bearer ${token}`;
    if (window.DEMO_USER_ID) h['x-user-id'] = window.DEMO_USER_ID; // mock auth fallback
    return h;
  }

  let page = 1;
  let since = '1970-01-01T00:00:00.000Z'; // notifications polling cursor

  document.addEventListener('DOMContentLoaded', ()=>{
    M.FormSelect.init(document.querySelectorAll('select'), {});
    M.Modal.init(document.querySelectorAll('.modal'), {});
    load();

    document.getElementById('search').addEventListener('input', debounce(load, 300));
    document.getElementById('sort').addEventListener('change', load);
    document.getElementById('label').addEventListener('input', debounce(load, 300));
    document.getElementById('unreadOnly').addEventListener('change', load);
    // includeExpired not implemented on backend (MVP) → ignored for now
    document.getElementById('includeExpired').addEventListener('change', load);

    document.getElementById('prev').onclick = (e)=> {
      if (document.getElementById('prevLi').classList.contains('disabled')) return;
      if (page > 1) { page--; load(); }
    };
    document.getElementById('next').onclick = (e)=> {
      if (document.getElementById('nextLi').classList.contains('disabled')) return;
      page++; load();
    };
    document.getElementById('btnSubmit').onclick = submitMemo;

    // polling notifications
    setInterval(pollNotifs, 4000);
  });

  async function load() {
    const q = new URLSearchParams();
    q.set('page', page);
    q.set('pageSize', 10);

    const label = document.getElementById('label').value.trim();
    const [sortKey, order] = document.getElementById('sort').value.split(':');
    const unreadOnly = document.getElementById('unreadOnly').checked;
    const includeExpired = document.getElementById('includeExpired').checked;

    if (label) q.set('label', label);
    if (unreadOnly) q.set('unread','true');
    if (includeExpired) q.set('includeExpired', 'true');
    q.set('sort', sortKey);
    q.set('order', order);

    const res = await fetch(API(`/memos?${q.toString()}`), { headers: getHeaders() });
    const json = await res.json();
    console.log('memos response ->', json);

    const items = json.data || json.items || [];
    const pageInfo = json.pageInfo || { page: 1, pageSize: 10, total: items.length, hasNext: false };

    document.getElementById('pageNum').textContent = pageInfo.page;
    const prevLi = document.getElementById('prevLi') || document.getElementById('prev')?.parentElement;
    const nextLi = document.getElementById('nextLi') || document.getElementById('next')?.parentElement;
    if (prevLi) prevLi.classList.toggle('disabled', pageInfo.page <= 1);
    if (nextLi) nextLi.classList.toggle('disabled', !pageInfo.hasNext);

    renderList(items);
    updateUnreadBadge(unreadCount);
  }


  function renderList(items) {
    const list = document.getElementById('list');
    if (!items.length) { list.innerHTML = `<p class="grey-text">No data</p>`; return; }
    list.innerHTML = items.map(m => `
      <div class="memo-row">
        <div>
          <span class="badge ${m.unread ? 'new':''}" data-badge-caption="${m.unread?'Unread':'Read'}"></span>
          <b>${escapeHtml(m.subject)}</b>
          <div class="grey-text">${escapeHtml((m.body||'').slice(0, 80))}${(m.body||'').length>80?'...':''}</div>
          <div class="badges">
            ${m.label ? `<span class="new badge" data-badge-caption="${escapeHtml(m.label)}"></span>` : ''}
            ${m.expiresAt ? `<span class="badge" data-badge-caption="exp:${new Date(m.expiresAt).toLocaleString()}"></span>`:''}
          </div>
        </div>
        <div>
          <a class="btn-flat" onclick="openMemo('${m._id}')">Open</a>
          ${renderClaimBtn(m)}
        </div>
      </div>
    `).join('');
  }

  function renderClaimBtn(m) {
    const now = Date.now();
    const expired = m.expiresAt && new Date(m.expiresAt).getTime() <= now;
    const att = m.attachments || null; // backend field is "attachments"
    if (!att) return '';
    if (expired) return `<a class="btn disabled">Expired</a>`;
    if (att.claimed) return `<a class="btn disabled">Claimed</a>`;
    return `<a class="btn" onclick="claim('${m._id}')">Claim</a>`;
  }

  function updateUnreadBadge(n) {
    const el = document.getElementById('unreadBadge');
    if (el) el.textContent = String(n ?? 0);
  }

  async function openMemo(id) {
    const res = await fetch(API(`/memos/${id}`), { headers: getHeaders() });
    const m = await res.json();
    if (!res.ok) { M.toast({ html: 'Failed to open memo' }); return; }
    M.toast({html: `#${m._id} opened: ${escapeHtml(m.subject)}`});
    load(); // refresh unread badge/list
  }

  async function claim(id) {
    const res = await fetch(API(`/memos/${id}/claim`), { method:'POST', headers: getHeaders() });
    const data = await res.json().catch(()=> ({}));
    if (res.ok) M.toast({ html: 'Claim successful!' });
    else M.toast({ html: `Failed: ${data.code || res.status}` });
    load();
  }

  async function submitMemo() {
    const subject = document.getElementById('subject').value.trim();
    const bodyText = document.getElementById('body').value.trim();
    const labelStr = document.getElementById('labels').value.split(',').map(s=>s.trim()).filter(Boolean)[0] || 'inbox';
    const expiresVal = document.getElementById('expiresAt').value;
    const attachments = parseJsonOrNull(document.getElementById('attachmentJson').value);
    // Backend expects: { subject, body, label, attachments, expiresAt? }
    const payload = {
      subject,
      body: bodyText,
      label: labelStr,
      attachments,                                // e.g. { "type":"coins", "qty":100 }
      expiresAt: expiresVal ? new Date(expiresVal).toISOString() : null
    };

    const res = await fetch(API('/memos'), { method:'POST', headers: getHeaders(), body: JSON.stringify(payload) });
    const data = await res.json().catch(()=> ({}));
    if (res.ok) { M.toast({ html: 'Created!' }); page = 1; load(); }
    else M.toast({ html: `Error: ${data.message || data.code || 'Failed to create memo'}` });
  }

  async function pollNotifs() {
    const res = await fetch(API(`/notifications?since=${encodeURIComponent(since)}`), { headers });
    if (!res.ok) return;
    const json = await res.json();
    const items = json.data || [];
    if (items.length) {
      since = items[items.length - 1].createdAt; // move cursor forward
      const badge = document.getElementById('notifBadge');
      badge.textContent = String((parseInt(badge.textContent,10) || 0) + items.length);
    }
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));}
  function parseJsonOrNull(s){ try{ return s?JSON.parse(s):null }catch(_){ return null } }
  function debounce(fn, delay){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),delay); }; }
</script>

</body>
</html>
